name: totesys ETL pipeline # shown in GHA


# load secrets into environment variables.
# These env vars are available to all jobs:
env:
  # TF_AWS_ACCESS_KEY_ID: '${{ secrets.AWS_ACCESS_KEY_ID }}'
  # TF_AWS_SECRET_ACCESS_KEY: '${{ secrets.TF_AWS_SECRET_ACCESS_KEY }}'

  TF_TOTESYS_DB_USER: "${{ secrets.TF_TOTESYS_DB_USER }}"
  TF_TOTESYS_DB_HOST: '${{ secrets.TF_TOTESYS_DB_HOST }}'
  TF_TOTESYS_DB_DB: '${{ secrets.TF_TOTESYS_DB_DB }}'
  TF_TOTESYS_DB_PASSWORD: '${{ secrets.TF_TOTESYS_DB_PASSWORD }}'
  TF_TOTESYS_DB_PORT: '${{ secrets.TF_TOTESYS_DB_PORT }}'

  TF_WAREHOUSE_DB_DB: '${{ secrets.TF_WAREHOUSE_DB_DB }}'
  TF_WAREHOUSE_DB_HOST: '${{ secrets.TF_WAREHOUSE_DB_HOST }}'
  TF_WAREHOUSE_DB_PASSWORD: '${{ secrets.TF_WAREHOUSE_DB_PASSWORD }}'
  TF_WAREHOUSE_DB_PORT: '${{ secrets.TF_WAREHOUSE_DB_PORT }}'
  TF_WAREHOUSE_DB_USER: '${{ secrets.TF_WAREHOUSE_DB_USER }}' 
  
  AWS_ALERT_EMAIL: '${{ secrets.AWS_ALERT_EMAIL }}' 
  AWS_CODE_BUCKET: '${{ secrets.AWS_CODE_BUCKET }}' 
  AWS_INGEST_BUCKET: '${{ secrets.AWS_INGEST_BUCKET }}' 
  AWS_PROCESS_BUCKET: '${{ secrets.AWS_PROCESS_BUCKET }}' 
  AWS_STATE_BUCKET: '${{ secrets.AWS_STATE_BUCKET }}' 
  AWS_TABLES_LIST: '${{ secrets.AWS_TABLES_LIST }}' 
  OLTP_NAME: '${{ secrets.OLTP_NAME }}' 
  TOTE_SYS_DB_DB: '${{ secrets.TOTE_SYS_DB_DB }}' 
  TOTE_SYS_DB_HOST: '${{ secrets.TOTE_SYS_DB_HOST }}' 
  TOTE_SYS_DB_PASSWORD: '${{ secrets.TOTE_SYS_DB_PASSWORD }}' 
  TOTE_SYS_DB_PORT: '${{ secrets.TOTE_SYS_DB_PORT }}' 
  TOTE_SYS_DB_USER: '${{ secrets.TOTE_SYS_DB_USER }}' 
  WAREHOUSE_DB_DB: '${{ secrets.WAREHOUSE_DB_DB }}' 
  WAREHOUSE_DB_HOST: '${{ secrets.WAREHOUSE_DB_HOST }}' 
  WAREHOUSE_DB_PASSWORD: '${{ secrets.WAREHOUSE_DB_PASSWORD }}' 
  WAREHOUSE_DB_PORT: '${{ secrets.WAREHOUSE_DB_PORT }}' 
  WAREHOUSE_DB_USER: '${{ secrets.WAREHOUSE_DB_USER }}' 
  WAREHOUSE_NAME: '${{ secrets.WAREHOUSE_NAME }}' 






on:
  push: # this is an event
    branches:  
      # - '**' # would run GHA on push to any branch
      - main  # run GHA only on push to branch main 

jobs:
  # Run tests and tool coverage
  run-tests-and-coverage:
    name: Run all tests and tool coverage

    runs-on: ubuntu-latest # always use a Linux VM
    steps:
        - name: Checkout the repo
          uses: actions/checkout@v5  # Download repo into runner

         # Install Python
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.12'

         # Install dependencies â€“ needed
         # so that the tests can run:
        - name: Install deps
          run: |
              python -m pip install --upgrade pip
              python -m pip install pip-tools
              cd requirements
              pip-compile GHA_test_requirements.in
              cd ..
              pip install -r requirements/GHA_test_requirements.txt            


        # Now run the tests and if a test 
        # fails, stop the job.
        # If coverage < 90%, the step 
        # fails and the job stops:
        - name: Run tests with coverage (min 90%)
          run: |
            coverage run --source=src -m pytest
            coverage report --fail-under=90

        # If any previous step in this job 
        # fails, stop the job. If all tests 
        # pass, print this in GHA log:  
        - name: Did tests and coverage pass?
          if: success()
          run: echo "All tests passed, coverage acceptable."

        - name: Did tests and coverage fail?
          if: failure()
          run: echo "One/2+ tests failed or coverage is <90%. GHA job stopped."

  # Run tests and tool coverage
  zip-lambdas:
    name: Zip the lambdas and place in folder zipped_files
    runs-on: ubuntu-latest
    steps:
        - name: Checkout the repo
          uses: actions/checkout@v5

         # zip lambdas
        - name: Zip lambdas
          run: |
            cd src/first_lambda
            zip -r ../../zipped_files/first_lambda.zip .
            cd "$GITHUB_WORKSPACE"
            cd src/second_lambda
            zip -r ../../zipped_files/second_lambda.zip .
            cd "$GITHUB_WORKSPACE"
            cd src/third_lambda
            zip -r ../../zipped_files/third_lambda.zip .
            cd "$GITHUB_WORKSPACE"

         # Install Python
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.12'

        - name: Make layer
        # NOTE: when you use a 
        # continuation character
        # ('\') you have to have 
        # an indent on the new 
        # lines:
          run: |
              python -m pip install --upgrade pip
              python -m pip install pip-tools
              cd requirements
              pip-compile GHA_layer_requirements.in
              cd ..
              mkdir -p layer/python/lib/python3.12/site-packages
              python -m pip install \
                -r requirements/GHA_layer_requirements.txt \
                -t layer/python/lib/python3.12/site-packages


        - name: Zip layer and place in folder zipped_files
          run: |
              cd layer
              zip -r ../zipped_files/layer.zip python            
















