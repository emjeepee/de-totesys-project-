name: totesys ETL pipeline # shown in GHA


# load secrets into environment variables.
# These env vars are available to all jobs:
env:
  # TF_AWS_ACCESS_KEY_ID: '${{ secrets.AWS_ACCESS_KEY_ID }}'
  # TF_AWS_SECRET_ACCESS_KEY: '${{ secrets.TF_AWS_SECRET_ACCESS_KEY }}'

  TF_TOTESYS_DB_USER: "${{ secrets.TF_TOTESYS_DB_USER }}"
  TF_TOTESYS_DB_HOST: '${{ secrets.TF_TOTESYS_DB_HOST }}'
  TF_TOTESYS_DB_DB: '${{ secrets.TF_TOTESYS_DB_DB }}'
  TF_TOTESYS_DB_PASSWORD: '${{ secrets.TF_TOTESYS_DB_PASSWORD }}'
  TF_TOTESYS_DB_PORT: '${{ secrets.TF_TOTESYS_DB_PORT }}'

  TF_WAREHOUSE_DB_DB: '${{ secrets.TF_WAREHOUSE_DB_DB }}'
  TF_WAREHOUSE_DB_HOST: '${{ secrets.TF_WAREHOUSE_DB_HOST }}'
  TF_WAREHOUSE_DB_PASSWORD: '${{ secrets.TF_WAREHOUSE_DB_PASSWORD }}'
  TF_WAREHOUSE_DB_PORT: '${{ secrets.TF_WAREHOUSE_DB_PORT }}'
  TF_WAREHOUSE_DB_USER: '${{ secrets.TF_WAREHOUSE_DB_USER }}' 
  
  

on:
  push: # this is an event
    branches:  
      # - '**' # would run GHA on push to any branch
      - main  # run GHA only on push to branch main 

jobs:
  # Run tests and tool coverage
  run-tests-and-coverage:
    name: Run all tests and tool coverage

    runs-on: ubuntu-latest # always use a Linux VM
    steps:
        - name: Checkout the repo
          uses: actions/checkout@v5  # Download repo into runner

         # Install Python
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.12'

         # Install dependencies â€“ needed
         # so that the tests can run:
        - name: Install deps
          run: |
              python -m pip install --upgrade pip
              python -m pip install pip-tools
              cd requirements
              pip-compile requirements.in
              cd ..
              pip install -r requirements/requirements.txt            


        # Now run the tests and if a test 
        # fails, stop the job.
        # If coverage < 90%, the step 
        # fails and the job stops:
        - name: Run tests with coverage (min 90%)
          run: |
            coverage run --source=src -m pytest
            coverage report --fail-under=90

        # If any previous step in this job 
        # fails, stop the job. If all tests 
        # pass, print this in GHA log:  
        - name: Did tests and coverage pass?
          if: success()
          run: echo "All tests passed, coverage acceptable."

        - name: Did tests and coverage fail?
          if: failure()
          run: echo "One test or more failed or coverage is <90%. GHA job stopped."
















